<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERVER HVH BEDWAR NESPOLA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Link Font Awesome để dùng icon Discord, User vector và icon thùng rác -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Keyframes cho hiệu ứng fade-in-up ban đầu của hero section */
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .initial-fade-in-up {
          animation: fadeIn 0.6s ease-out forwards;
        }
        .delay-200 { animation-delay: 0.2s; }
        .delay-400 { animation-delay: 0.4s; }

        /* Keyframes và classes cho hiệu ứng cuộn đa dạng hơn */
        .animated-section {
            opacity: 0;
            transition: opacity 0.8s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .animated-section.is-visible {
            opacity: 1;
            transform: translateY(0) translateX(0) scale(1);
        }

        .slide-in-up-on-scroll {
            transform: translateY(30px);
        }
        .slide-in-left-on-scroll {
            transform: translateX(-50px);
        }
        .slide-in-right-on-scroll {
            transform: translateX(50px);
        }
        .scale-in-on-scroll {
            transform: scale(0.95);
        }

        /* Keyframes cho hiệu ứng gradient di chuyển của chữ NESPOLA */
        @keyframes gradient-breath {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        .animate-gradient-text {
            /* Điều chỉnh màu sắc gradient để tạo sự nổi bật hơn */
            background: linear-gradient(90deg, #10B981, #6EE7B7, #10B981); /* Darker Green, Lighter Green, Darker Green */
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text; /* Thêm dòng này cho tương thích tốt hơn */
            -webkit-text-fill-color: transparent;
            animation: gradient-breath 4s ease infinite; /* Thời gian animation dài hơn, mượt mà */
            /* Thêm hiệu ứng glow cho chữ NESPOLA */
            text-shadow: 0 0 10px rgba(52, 211, 153, 0.7), /* Green-500 with 70% opacity */
                         0 0 20px rgba(52, 211, 153, 0.5); /* Green-500 with 50% opacity */
            transition: text-shadow 0.3s ease; /* Thêm transition cho mượt mà */
        }

        .modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .card-effect {
            border: 1px solid transparent;
            /* Cập nhật easing animation cho mượt mà hơn */
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .card-effect:hover {
            border-color: #34D399;
            /* Mạnh hơn glow cho card */
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.4), 0 0 30px rgba(52, 211, 153, 0.2); /* Green glow for the card border */
            transform: translateY(-5px);
        }
        /* Custom selection highlight color */
        ::selection {
          background-color: #34D399; /* Green-500 */
          color: #ffffff; /* White text on selection */
        }
        ::-moz-selection { /* For Firefox */
          background-color: #34D399;
          color: #ffffff;
        }

        .modal-overlay {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        /* Style for logged-in user display */
        .user-display {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Tailwind 'gap-2' */
            font-weight: 600; /* Tailwind 'font-semibold' */
            color: #4A5568; /* Tailwind 'text-gray-700' */
        }
        .user-display button {
            margin-left: 0.5rem; /* Tailwind 'ml-2' */
            padding: 0.5rem 1rem; /* Tailwind 'px-4 py-2' */
            background-color: #EF4444; /* Tailwind 'bg-red-500' */
            color: #FFFFFF; /* Tailwind 'text-white' */
            border-radius: 0.5rem; /* Tailwind 'rounded-lg' */
            font-weight: 500; /* Tailwind 'font-medium' */
            transition: background-color 0.2s ease-in-out;
        }
        .user-display button:hover {
            background-color: #DC2626; /* Tailwind 'hover:bg-red-600' */
        }
        /* Styling for the chat box */
        .chat-container {
            max-height: 400px; /* Limit chat height */
            overflow-y: auto; /* Scrollable chat area */
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 2rem;
            background-color: #F8FAFC;
        }
        .chat-message {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: flex-start; /* Align header and text at start */
            position: relative; /* For delete button positioning */
        }
        .chat-message-content {
            flex-grow: 1;
        }
        .chat-message-header {
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            color: #2D3748; /* gray-800 */
        }
        /* Style for user role in chat */
        /* Removed .chat-user-role style as roles are removed */
        .chat-message-text {
            font-size: 0.95rem;
            color: #4A5568; /* gray-700 */
            word-wrap: break-word; /* Ensure long words break */
        }
        .chat-input-area {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .chat-input-area textarea {
            flex-grow: 1;
            border: 1px solid #CBD5E0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            resize: vertical; /* Allow vertical resize */
            min-height: 40px;
            max-height: 120px; /* Limit max height of textarea */
        }
        .chat-input-area button {
            padding: 0.75rem 1rem;
            background-color: #34D399; /* Green-500 */
            color: white;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .chat-input-area button:hover {
            background-color: #10B981; /* Green-600 */
        }
        /* Style for user role in header */
        /* Removed .header-user-role style as roles are removed */
        .delete-message-btn {
            background: none;
            border: none;
            color: #EF4444; /* red-500 */
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 0.5rem;
            padding: 0;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        .delete-message-btn:hover {
            opacity: 1;
        }
        .message-user-id {
            font-size: 0.7rem;
            color: #9CA3AF; /* gray-400 */
            margin-left: 0.5rem;
        }

        /* Styling for Ban Modal */
        #ban-modal .modal-content {
            background-color: #FEE2E2; /* Red-100 */
            border: 2px solid #EF4444; /* Red-500 */
        }
        #ban-modal .modal-content h3 {
            color: #DC2626; /* Red-600 */
        }
        #ban-modal .modal-content p {
            color: #B91C1C; /* Red-700 */
        }

        /* Styles for Mouse-follow Spotlight and Glow effect (no blur) - COMMENTED OUT */
        /*
        .spotlight-image-card {
            position: relative;
            overflow: hidden;
            cursor: none;
            border-radius: 0.5rem;
            background-size: cover;
            background-position: center;
            background-image: var(--image-url);
            
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            transition: box-shadow 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            
            --mouse-x: 50%;
            --mouse-y: 50%;
            --glow-size: 0px;
            --glow-blur: 0px;
            --glow-opacity: 0;
        }
        */

        /* New element for the glowing halo around the spotlight - COMMENTED OUT */
        /*
        .spotlight-image-card .glow-halo {
            position: absolute;
            top: var(--mouse-y);
            left: var(--mouse-x);
            width: var(--glow-size);
            height: var(--glow-size);
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(52, 211, 153, 0.3), transparent 70%);
            filter: blur(var(--glow-blur));
            border-radius: 50%;
            pointer-events: none;
            opacity: var(--glow-opacity);
            transition: opacity 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                        width 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                        height 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 3;
        }
        */

        /* Hover effects on the card itself for overall glow - COMMENTED OUT */
        /*
        .spotlight-image-card:hover {
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.4), 0 0 30px rgba(52, 211, 153, 0.2);
        }
        */

        /* New class for button hover effect */
        .button-hover-effect:hover {
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.4), 0 0 30px rgba(52, 211, 153, 0.2); /* Green glow for the button */
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"; 
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js"; 
        import { getFirestore, collection, query, orderBy, addDoc, serverTimestamp, onSnapshot, doc, getDoc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"; 
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-analytics.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB2S9V-EhHHsCQ_rxEUgA5DXfeZkFwOijY",
            authDomain: "nespola-294d7.firebaseapp.com",
            projectId: "nespola-294d7",
            storageBucket: "nespola-294d7.appspot.com", 
            messagingSenderId: "893545252364",
            appId: "1:893545252364:web:3dd780e52ef2a0b5795029",
            measurementId: "G-2GLRRM71RV" 
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); 
        const analytics = getAnalytics(app);

        if (typeof __initial_auth_token !== 'undefined') {
            signInWithCustomToken(auth, __initial_auth_token).catch((error) => {
                console.error("Lỗi khi đăng nhập bằng custom token:", error);
                signInAnonymously(auth);
            });
        } else {
            signInAnonymously(auth).catch((error) => {
                console.error("Lỗi khi đăng nhập ẩn danh:", error);
            });
        }

        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db; 
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        // Export Firestore functions for use in script
        window.firestoreCollection = collection;
        window.firestoreQuery = query;
        window.firestoreOrderBy = orderBy;
        window.firestoreAddDoc = addDoc;
        window.firestoreServerTimestamp = serverTimestamp;
        window.firestoreOnSnapshot = onSnapshot;
        window.firestoreDoc = doc; 
        window.firestoreGetDoc = getDoc; 
        window.firestoreSetDoc = setDoc; 
        window.firestoreDeleteDoc = deleteDoc; 
        window.firestoreUpdateDoc = updateDoc; // Export updateDoc
        window.appId = appId; 
    </script>
</head>
<body class="min-h-screen bg-white text-gray-800 antialiased">
    <div class="absolute inset-0 bg-gradient-to-br from-gray-50 via-white to-gray-100 z-0 pointer-events-none"></div>
    <div class="absolute inset-0 z-0 pointer-events-none" style="
        background-image: url(&quot;data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 20v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zm0 20v-4H4v4H0v2h4v4h2v-4h4v-2H6zM36 4V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 4V0H4v4H0v2h4v4h2V6h4V4H6zM21 20v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 20v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zM21 0v-4h-2v4h-4v2h4v4h2V6h4V4h-4zM41 20v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 20v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zM41 0v-4h-2v4h-4v2h4v4h2V6h4V4h-4zM11 9v-4h-2v4H5v2h4v4h2v-4h4V9h-4zm0 20v-4h-2v4H5v2h4v4h2v-4h4v-2h-4zm0 20v-4h-2v4H5v2h4v4h2v-4h4v-2h-4zm30-30v-4h-2v4h-4v2h4v4h2v-4h4V9h-4zm0 20v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 20v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E&quot;);
        background-size: 100px 100px;"></div>

    <header class="relative z-10 bg-white shadow-sm">
        <nav class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <!-- Logo của server -->
                <img src="./logo.png" alt="NESPOLA Server Logo" class="h-10 md:h-12 object-contain">
            </div>

            <div class="flex items-center space-x-4">
                <span class="text-gray-600 font-semibold text-sm">v2.0</span>
                
                <!-- Login/Logout and User Info Display -->
                <a
                    href="login.html"
                    id="login-button"
                    class="flex items-center px-4 py-2 bg-green-500 text-white rounded-lg shadow hover:bg-green-600 transition-colors duration-200"
                >
                    <i class="fas fa-user mr-2"></i> Đăng nhập
                </a>

                <div id="user-info-display" class="hidden user-display">
                    <a href="userinfo.html" id="user-email-link" class="text-gray-700 hover:text-green-600 font-semibold text-sm"></a>
                    <button id="logout-button">Đăng xuất</button>
                </div>
            </div>

            <div class="md:hidden">
                <button class="p-2 text-gray-600 hover:text-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 rounded-md">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </nav>
    </header>

    <main class="relative z-10 flex flex-col items-center justify-center min-h-[calc(100vh-6rem)] text-center px-4 py-16 md:py-24">
        <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 leading-tight mb-4 initial-fade-in-up">
            SERVER HVH BEDWAR <br />
            <span class="animate-gradient-text">NESPOLA</span>
        </h1>

        <p class="text-lg md:text-xl text-gray-600 max-w-2xl mb-8 initial-fade-in-up delay-200">
            Khám phá thế giới Bedwars đầy kịch tính, chinh phục mọi đối thủ và trải nghiệm những trận chiến bất tận cùng cộng đồng NESPOLA!
        </p>

        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 initial-fade-in-up delay-400">
            <a
                href="#content-sections" id="explore-server-btn"
                class="flex items-center justify-center px-8 py-4 bg-green-500 text-white font-semibold rounded-lg shadow-lg hover:bg-green-600 transition-all duration-300 transform hover:scale-105 button-hover-effect"
            >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="text-white mr-2"
                >
                  <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z" />
                  <path d="M14.71 14.71L12 17.41l-2.71-2.71a4 4 0 1 1 5.42 0z" />
                  <path d="M16 12l-4 4-4-4" />
                  <path d="M12 8V2" />
                  <path d="M12 22V16" />
                  <path d="M22 12H16" />
                  <path d="M8 12H2" />
                  <circle cx="12" cy="12" r="2" />
                </svg>
                Khám phá server
            </a>
            <a
                href="./about.html"
                class="flex items-center justify-center px-8 py-4 border-2 border-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 button-hover-effect">
                Tìm hiểu thêm <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            </a>
            <a
                href="./tut.html"
                class="flex items-center justify-center px-8 py-4 border-2 border-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 button-hover-effect">
                <i class="fas fa-book mr-2"></i> Cách vào
            </a>
            <button
                id="join-server-btn"
                class="flex items-center justify-center px-8 py-4 bg-blue-500 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 button-hover-effect"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="M12 5v14"/><path d="m19 12-7 7-7-7"/>
                </svg>
                Server IP
            </button>
        </div>
    </main>

    <section id="content-sections" class="relative z-10 py-16 md:py-24 bg-gray-50">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-20 items-center animated-section slide-in-up-on-scroll">
                <div class="order-2 md:order-1">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4">
                        Kết nối và Chiến đấu
                    </h2>
                    <p class="text-lg text-gray-600 mb-6">
                        Kết nối với server NESPOLA dễ dàng và nhanh chóng. Chọn chế độ Bedwars yêu thích, tham gia trận đấu và bắt đầu cuộc chiến đầy kịch tính chỉ với vài bước đơn giản!
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700">
                        <p class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-600"><circle cx="12" cy="12" r="10"/><path d="M16.24 7.76a6 6 0 0 0-8.49 0"/><path d="M11.66 16.34a2 2 0 0 0 2.83 0"/></svg> Phát hiện trận đấu nhanh</p>
                        <p class="flex items-center">
                            <!-- Fixed Bell Icon SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-600">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                <path d="M13.73 21a2 2 0 = 1-3.46 0"></path>
                            </svg>
                            Thông báo sự kiện
                        </p>
                        <p class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-600"><path d="M22 12H2"/><path d="M15 19l7-7-7-7"/></svg> Trải nghiệm mượt mà</p>
                        <p class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-600"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v6"/><path d="m15 15-3 3-3-3"/></svg> Server ổn định</p>
                    </div>
                </div>
                <!-- Ảnh cho phần "Kết nối và Chiến đấu" -->
                <div class="order-1 md:order-2 flex justify-center items-center w-full max-w-md rounded-lg overflow-hidden shadow-lg aspect-video card-effect group"
                     data-image-src="./anh-pvp.png" style="background-image: url('./anh-pvp.png'); background-size: cover; background-position: center;">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-20 items-center animated-section slide-in-up-on-scroll">
                <!-- Ảnh cho phần "Theo dõi các event bạn yêu thích" -->
                <div class="order-1 md:order-1 flex justify-center items-center w-full max-w-md rounded-lg overflow-hidden shadow-lg aspect-video card-effect group"
                     data-image-src="./anh-event.png" style="background-image: url('./anh-event.png'); background-size: cover; background-position: center;">
                </div>
                <div class="order-2 md:order-2">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4">
                        Theo dõi các event bạn yêu thích
                    </h2>
                    <p class="text-lg text-gray-600 mb-6">
                        Nhận thông báo mỗi khi các sự kiện hoặc giải đấu mới được tổ chức và luôn nắm bắt mọi thông tin quan trọng nhất.
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700">
                        <p class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-600"><path d="M6 8a6 6 0 = 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg> Thông báo sự kiện</p>
                        <p class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-600"><path d="M22 12H2"/><path d="M18 5l4 7-4 7"/><path d="M6 5l-4 7 4 7"/></svg> Cập nhật thường xuyên</p>
                    </div>
                </div>
            </div>

            <div class="text-center mb-16 animated-section slide-in-up-on-scroll">
                <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4">
                    Chinh phục mọi thử thách, làm chủ cuộc chơi!
                </h2>
                <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                    Trải nghiệm Bedwars HVH đỉnh cao với các tính năng độc quyền, giúp bạn nâng tầm kỹ năng và thể hiện bản lĩnh.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 animated-section scale-in-on-scroll">
                <div class="p-6 bg-white rounded-lg shadow-md flex items-start space-x-4 card-effect group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600 mt-1"><circle cx="12" cy="12" r="10"/><path d="M16.24 7.76a6 6 0 0 0-8.49 0"/><path d="M11.66 16.34a2 2 0 0 0 2.83 0"/></svg>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Khám phá chiến trường</h3>
                        <p class="text-gray-600">Khám phá đa dạng các bản đồ Bedwars với địa hình và chiến thuật độc đáo, không ngừng đổi mới.</p>
                    </div>
                </div>
                <div class="p-6 bg-white rounded-lg shadow-md flex items-start space-x-4 card-effect group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600 mt-1"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Đội hình bất bại</h3>
                        <p class="text-gray-600">Lập đội cùng bạn bè, xây dựng chiến thuật thông minh và phối hợp ăn ý để thống trị mọi trận đấu.</p>
                    </div>
                </div>
                <div class="p-6 bg-white rounded-lg shadow-md flex items-start space-x-4 card-effect group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600 mt-1"><path d="M15 5 6 6-6 6"/><path d="M3 12h18"/></svg>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Thăng cấp & Nhận thưởng</h3>
                        <p class="text-gray-600">Đạt thứ hạng cao trên bảng xếp hạng, mở khóa phần thưởng độc quyền và chứng tỏ kỹ năng của bạn.</p>
                    </div>
                </div>
                <div class="p-6 bg-white rounded-lg shadow-md flex items-start space-x-4 card-effect group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600 mt-1"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Chế độ độc đáo</h3>
                        <p class="text-gray-600">Trải nghiệm nhiều chế độ chơi Bedwars độc đáo, cùng các sự kiện và giải đấu hấp dẫn được tổ chức thường xuyên.</p>
                    </div>
                </div>
                <div class="p-6 bg-white rounded-lg shadow-md flex items-start space-x-4 card-effect group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600 mt-1"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Thống kê chi tiết</h3>
                        <p class="text-gray-600">Theo dõi mọi chỉ số: KDA, win-rate, số trận thắng, và thứ hạng của bạn để cải thiện kỹ năng.</p>
                    </div>
                </div>
                <div class="p-6 bg-white rounded-lg shadow-md flex items-start space-x-4 card-effect group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600 mt-1"><path d="M22 12H2"/><path d="M18 5l4 7-4 7"/><path d="M6 5l-4 7 4 7"/></svg>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Cập nhật không ngừng</h3>
                        <p class="text-gray-600">Máy chủ luôn được cập nhật các bản đồ, chế độ mới và tối ưu hóa hiệu suất để mang lại trải nghiệm mượt mà nhất.</p>
                    </div>
                </div>
            </div>

            <!-- Tham gia cộng đồng section -->
            <div class="text-center mt-20 animated-section slide-in-up-on-scroll">
                <div class="flex justify-center mb-8">
                    <svg
                      width="64"
                      height="64"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="text-green-600"
                    >
                      <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z" />
                      <path d="M14.71 14.71L12 17.41l-2.71-2.71a4 4 0 1 1 5.42 0z" />
                      <path d="M16 12l-4 4-4-4" />
                      <path d="M12 8V2" />
                      <path d="M12 22V16" />
                      <path d="M22 12H16" />
                      <path d="M8 12H2" />
                      <circle cx="12" cy="12" r="2" />
                    </svg>
                </div>
                <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-6">
                    Tham gia cộng đồng NESPOLA ngay!
                </h2>
                <a
                    href="https://discord.gg/gYTRrGx8Vv"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105"
                >
                    <i class="fab fa-discord w-5 h-5 mr-2 text-xl"></i>
                    Tham gia Discord
                </a>
            </div>

            <!-- Chat Section -->
            <div class="mt-20 px-4 py-8 bg-white rounded-lg shadow-xl max-w-3xl mx-auto text-left">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">
                    Trò chuyện cộng đồng
                </h2>
                <div id="chat-messages" class="chat-container">
                    <!-- Chat messages will be loaded here -->
                    <p class="text-gray-500 text-center">Đang tải tin nhắn...</p>
                </div>
                <div class="chat-input-area">
                    <textarea id="chat-message-input" placeholder="Nhập tin nhắn của bạn..." class="focus:outline-none focus:ring-2 focus:ring-green-500" maxlength="200"></textarea>
                    <button id="send-chat-button">Gửi</button>
                </div>
            </div>

        </div>
    </section>

    <!-- Join Server Modal (Now displays the error message as per user request) -->
    <div id="join-server-modal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl relative w-11/12 max-w-sm text-center">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <h3 class="text-2xl font-bold text-red-600 mb-4">Lỗi: Server chưa phát hành!</h3>
            <p class="text-gray-700 mb-4">
                SERVER HVH BEDWAR NESPOLA hiện chưa được phát hành.
            </p>
            <p class="text-gray-700 mb-6 font-semibold">
                Vui lòng thử lại sau hoặc theo dõi kênh Discord để nhận thông báo sớm nhất nhé!
            </p>
            <a
                href="https://discord.gg/gYTRrGx8Vv"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105"
            >
                <i class="fab fa-discord w-5 h-5 mr-2 text-xl"></i>
                Tham gia Discord
            </a>
        </div>
    </div>

    <!-- Ban Modal (New) -->
    <div id="ban-modal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl relative w-11/12 max-w-md text-center">
            <button id="close-ban-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <h3 class="text-2xl font-bold text-red-600 mb-4">Bạn đã bị cấm!</h3>
            <p id="ban-reason-display" class="text-gray-700 mb-2"></p>
            <p id="ban-until-display" class="text-gray-700 mb-6"></p>
        </div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const loginButton = document.getElementById('login-button');
            const userInfoDisplay = document.getElementById('user-info-display');
            const userEmailLink = document.getElementById('user-email-link');
            const logoutButton = document.getElementById('logout-button');

            const joinServerBtn = document.getElementById('join-server-btn');
            const joinServerModal = document.getElementById('join-server-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');

            // Chat elements
            const chatMessagesDiv = document.getElementById('chat-messages');
            const chatMessageInput = document.getElementById('chat-message-input');
            const sendChatButton = document.getElementById('send-chat-button');

            // Ban Modal elements
            const banModal = document.getElementById('ban-modal');
            const closeBanModalBtn = document.getElementById('close-ban-modal-btn');
            const banReasonDisplay = document.getElementById('ban-reason-display');
            const banUntilDisplay = document.getElementById('ban-until-display');

            // Firebase instances and functions from window object
            const auth = window.firebaseAuth;
            const onAuthStateChanged = window.onAuthStateChanged;
            const signOut = window.signOut;
            const db = window.firebaseDb; 
            const firestoreCollection = window.firestoreCollection;
            const firestoreQuery = window.firestoreQuery;
            const firestoreOrderBy = window.firestoreOrderBy;
            const firestoreAddDoc = window.firestoreAddDoc;
            const firestoreServerTimestamp = window.firestoreServerTimestamp;
            const firestoreOnSnapshot = window.firestoreOnSnapshot;
            const firestoreDoc = window.firestoreDoc; 
            const firestoreGetDoc = window.firestoreGetDoc; 
            const firestoreSetDoc = window.firestoreSetDoc; 
            const firestoreDeleteDoc = window.firestoreDeleteDoc; 
            const firestoreUpdateDoc = window.firestoreUpdateDoc; // Export updateDoc
            const appId = window.appId; 


            let currentUserDisplayName = 'Khách'; 
            let currentUserId = null; 
            let currentUserForbiddenWordCount = 0; // Thêm biến để lưu số từ cấm của user
            let isBanned = false; // Trạng thái cấm của người dùng
            let banDetails = null; // Chi tiết về lệnh cấm

            // Spam prevention variables
            let lastMessageTime = 0;
            const MESSAGE_COOLDOWN = 2000; // 2 seconds cooldown
            const MAX_MESSAGE_LENGTH = 200; // Max 200 characters
            const LAST_MESSAGES_TO_CHECK = 3; // Number of previous messages to check for repetition
            let lastSentMessages = []; // Stores the content of the last sent messages

            // Simple forbidden words list (client-side, easily bypassed)
            const forbiddenWords = [
                'địt', 'đụ', 'buồi', 'lồn', 'cặc', 'chửi tục', 'đm', 'dm', 'fuck', 'bitch', 
                'đĩ', 'phò', 'đầu b**i', 'lon', 'cai', 'dit me', 'du me', 'vc', 'vcl', 'cc', 
                'cl', 'clgt', 'đcm', 'concac', 'ditconme', 'dau boi', 'loz', 'cac', 'ccmm', 'xoạc', 'súc vật', 
                'ngu lol', 'ngu lồn', 'ngu cặc', 'ngu buồi', 'óc chó', 'thằng ngu', 'con chó', 'thằng đĩ', 
                'phắc kiu', 'mẹ mày', 'cha mày', 'tổ tông', 'bố mày', 'con mẹ mày', 'thằng chó', 'cút mẹ mày', 
                'đồ bỏ', 'đồ khốn', 'mày ngu', 'đần độn', 'chết tiệt', 'cứt', 'đái', 'ỉa', 'ghẻ', 'hôi nách',
                'đần', 'bán lồn', 'đú đởn', 'đĩ điếm', 'đổ đốn', 'mất dạy', 'vô giáo dục', 'súc sinh', 'lũ chó',
                'cứt trôi', 'rác rưởi', 'hành hạ', 'ám sát', 'tàn sát', 'giết', 'chết đi', 'khốn nạn', 'đồ điên',
                'vô liêm sỉ', 'đáng khinh', 'bệnh hoạn', 'tởm lợm', 'dâm', 'dâm dục', 'quần què', 'cái chó gì',
                'con cặc', 'cứt đái', 'đéo', 'đéo mẹ', 'đụ mẹ', 'đụ má', 'lồn má', 'buồi má', 'cặc má', 'óc c*t'
            ];


            // Hàm chuẩn hóa chuỗi để so sánh (loại bỏ khoảng trắng thừa, chuyển về chữ thường)
            const normalizeString = (str) => {
                // Loại bỏ dấu câu và chuyển về chữ thường, sau đó loại bỏ khoảng trắng thừa
                return str.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s+/g,' ').trim();
            };

            // Hàm kiểm tra tin nhắn có chứa từ cấm không
            const containsForbiddenWord = (message) => {
                const normalizedMessage = normalizeString(message);
                for (let word of forbiddenWords) {
                    // Chuẩn hóa từ cấm và kiểm tra
                    if (normalizedMessage.includes(normalizeString(word))) {
                        return true;
                    }
                }
                return false;
            };

            // Hàm kiểm tra tin nhắn lặp lại
            const isRepeatingMessage = (message) => {
                const normalizedNewMessage = normalizeString(message);
                return lastSentMessages.some(lastMsg => {
                    const normalizedLastMsg = normalizeString(lastMsg);
                    // Hiện tại chỉ so sánh y hệt để đơn giản
                    return normalizedNewMessage === normalizedLastMsg;
                });
            };

            // Hàm hiển thị modal cấm
            const showBanModal = (reason, banUntil) => {
                banReasonDisplay.textContent = `Lý do: ${reason}`;
                if (banUntil === 'permanent') {
                    banUntilDisplay.textContent = `Bạn đã bị cấm vĩnh viễn.`;
                } else {
                    const untilDate = new Date(banUntil);
                    banUntilDisplay.textContent = `Bạn sẽ bị cấm đến: ${untilDate.toLocaleString('vi-VN')}`;
                }
                banModal.classList.add('open');
                // Tự động ẩn modal sau 5 giây nếu không phải ban vĩnh viễn
                if (banUntil !== 'permanent') {
                    setTimeout(() => {
                        banModal.classList.remove('open');
                    }, 5000);
                }
            };

            // Hàm đóng modal cấm
            const closeBanModal = () => {
                banModal.classList.remove('open');
            };
            
            // Xử lý sự kiện đóng modal cấm
            closeBanModalBtn.addEventListener('click', closeBanModal);
            banModal.addEventListener('click', (e) => {
                if (e.target === banModal) {
                    closeBanModal();
                }
            });

            // Hàm áp dụng lệnh cấm
            const applyBan = async (userId, banDurationDays, reason, banLevel) => {
                const banUntil = banDurationDays === 'permanent' ? 'permanent' : new Date(Date.now() + banDurationDays * 24 * 60 * 60 * 1000);
                
                const banDocRef = firestoreDoc(db, 'banned_users', userId); // Collection 'banned_users'
                
                try {
                    await firestoreSetDoc(banDocRef, {
                        userId: userId,
                        userName: currentUserDisplayName,
                        banReason: reason,
                        banUntil: banUntil,
                        banLevel: banLevel,
                        bannedAt: firestoreServerTimestamp()
                    }, { merge: true });
                    isBanned = true;
                    banDetails = { reason, banUntil };
                    console.warn(`Người dùng ${currentUserDisplayName} (${userId}) đã bị cấm. Lý do: ${reason}, Đến: ${banUntil}. Cấp độ ban: ${banLevel}`);
                    showBanModal(reason, banUntil === 'permanent' ? 'permanent' : banUntil.getTime());
                } catch (error) {
                    console.error("Lỗi khi áp dụng lệnh cấm:", error);
                    alert("Không thể áp dụng lệnh cấm: " + error.message);
                }
            };

            // --- Logic xử lý trạng thái đăng nhập và tải thông tin hồ sơ ---
            if (auth && onAuthStateChanged && db && firestoreDoc && firestoreGetDoc && firestoreSetDoc && firestoreUpdateDoc) {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        loginButton.classList.add('hidden');
                        userInfoDisplay.classList.remove('hidden');
                        currentUserId = user.uid; 

                        const userProfileRef = firestoreDoc(db, 'artifacts', appId, 'users', user.uid, 'user_profile_data', 'profile_doc');
                        const banDocRef = firestoreDoc(db, 'banned_users', user.uid);

                        try {
                            // Fetch user profile
                            const profileSnap = await firestoreGetDoc(userProfileRef);
                            if (profileSnap.exists()) {
                                const profileData = profileSnap.data();
                                currentUserDisplayName = profileData.userName || user.displayName || user.email || 'Người dùng';
                                currentUserForbiddenWordCount = profileData.forbiddenWordCount || 0;
                            } else {
                                // Create a default profile if it doesn't exist
                                currentUserDisplayName = user.displayName || user.email || 'Người dùng';
                                currentUserForbiddenWordCount = 0;
                                await firestoreSetDoc(userProfileRef, {
                                    userName: currentUserDisplayName,
                                    forbiddenWordCount: currentUserForbiddenWordCount,
                                    createdAt: firestoreServerTimestamp()
                                }, { merge: true }); 
                            }

                            // Check ban status
                            const banSnap = await firestoreGetDoc(banDocRef);
                            if (banSnap.exists()) {
                                const banData = banSnap.data();
                                const banUntilTimestamp = banData.banUntil;

                                if (banUntilTimestamp === 'permanent' || (banUntilTimestamp && banUntilTimestamp.toDate() > new Date())) {
                                    isBanned = true;
                                    banDetails = {
                                        reason: banData.banReason,
                                        banUntil: banUntilTimestamp === 'permanent' ? 'permanent' : banUntilTimestamp.toDate()
                                    };
                                    showBanModal(banDetails.reason, banDetails.banUntil === 'permanent' ? 'permanent' : banDetails.banUntil.getTime());
                                    console.warn(`Người dùng ${currentUserDisplayName} (${currentUserId}) đang bị cấm.`);
                                } else {
                                    // Ban has expired, remove ban record and reset banLevel if needed
                                    await firestoreDeleteDoc(banDocRef);
                                    isBanned = false;
                                    banDetails = null;
                                    // Optionally reset forbiddenWordCount or banLevel in profile if ban expired naturally
                                    // await firestoreUpdateDoc(userProfileRef, { banLevel: 0 }); 
                                }
                            } else {
                                isBanned = false;
                                banDetails = null;
                            }

                        } catch (error) {
                            console.error("Lỗi khi tải hồ sơ hoặc trạng thái cấm:", error);
                            currentUserDisplayName = user.displayName || user.email || 'Người dùng';
                            currentUserForbiddenWordCount = 0;
                            isBanned = false;
                            banDetails = null;
                        }
                        
                        userEmailLink.textContent = currentUserDisplayName; 
                        userEmailLink.href = 'userinfo.html'; 
                    } else {
                        loginButton.classList.remove('hidden');
                        userInfoDisplay.classList.add('hidden');
                        currentUserDisplayName = 'Khách';
                        currentUserId = null; 
                        currentUserForbiddenWordCount = 0;
                        isBanned = false;
                        banDetails = null;
                    }
                });

                if (logoutButton) {
                    logoutButton.addEventListener('click', async () => {
                        try {
                            await signOut(auth);
                            console.log("Đăng xuất thành công!");
                            // Reset current user info and last messages after logout
                            currentUserDisplayName = 'Khách';
                            currentUserId = null;
                            currentUserForbiddenWordCount = 0;
                            isBanned = false;
                            banDetails = null;
                            userEmailLink.textContent = '';
                            lastSentMessages = []; // Clear last sent messages
                        } catch (error) {
                            console.error("Lỗi khi đăng xuất:", error);
                        }
                    });
                }
            } else {
                console.error("Firebase Auth, Firestore hoặc các hàm liên quan chưa được khởi tạo. Đảm bảo bạn đã import đúng.");
            }
            // --- Kết thúc logic xử lý trạng thái đăng nhập và tải thông tin hồ sơ ---
            
            // Hàm xóa tin nhắn
            const deleteChatMessage = async (messageId, messageUserId) => {
                // Modified: Now only allows a user to delete their own messages if logged in
                if (!currentUserId || currentUserId !== messageUserId) {
                    alert("Bạn không có quyền để xóa tin nhắn này.");
                    return;
                }

                if (confirm("Bạn có chắc muốn xóa tin nhắn này?")) { 
                    try {
                        const messageDocRef = firestoreDoc(db, "chat_messages", messageId);
                        await firestoreDeleteDoc(messageDocRef);
                        console.log(`Tin nhắn ${messageId} đã được xóa bởi ${currentUserDisplayName}`);
                    } catch (error) {
                        console.error("Lỗi khi xóa tin nhắn:", error);
                        alert("Không thể xóa tin nhắn: " + error.message);
                    }
                }
            };

            // --- Logic cho chức năng chat ---
            if (db && firestoreCollection && firestoreQuery && firestoreOrderBy && firestoreOnSnapshot && firestoreDeleteDoc && firestoreUpdateDoc) {
                const messagesRef = firestoreCollection(db, "chat_messages");
                const q = firestoreQuery(messagesRef, firestoreOrderBy("timestamp")); 

                // Lắng nghe tin nhắn theo thời gian thực
                firestoreOnSnapshot(q, (snapshot) => {
                    chatMessagesDiv.innerHTML = ''; 
                    if (snapshot.empty) {
                        chatMessagesDiv.innerHTML = '<p class="text-gray-500 text-center">Chưa có tin nhắn nào. Hãy là người đầu tiên gửi tin!</p>';
                    }
                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        const messageId = doc.id; 
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('chat-message');
                        
                        const senderName = message.userName || 'Khách';
                        const senderUserId = message.userId || 'N/A'; 
                        const timestamp = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString('vi-VN') : 'Vừa xong'; 

                        // Create the message content
                        const messageContentDiv = document.createElement('div');
                        messageContentDiv.classList.add('chat-message-content');
                        messageContentDiv.innerHTML = `
                            <div class="chat-message-header">
                                ${senderName} 
                                <span class="text-gray-400 text-xs ml-2">${timestamp}</span>
                                ${senderUserId !== 'anonymous' ? `<span class="message-user-id">(ID: ${senderUserId.substring(0, 5)}...)</span>` : ''}
                            </div>
                            <div class="chat-message-text">${message.text}</div>
                        `;
                        messageElement.appendChild(messageContentDiv);

                        // Add delete button if current user is the sender of the message
                        if (currentUserId && currentUserId === senderUserId) {
                            const deleteBtn = document.createElement('button');
                            deleteBtn.classList.add('delete-message-btn');
                            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                            deleteBtn.title = 'Xóa tin nhắn của bạn';
                            deleteBtn.addEventListener('click', () => deleteChatMessage(messageId, senderUserId));
                            messageElement.appendChild(deleteBtn);
                        }

                        chatMessagesDiv.appendChild(messageElement);
                    });
                    // Cuộn xuống cuối chat
                    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                }, (error) => {
                    console.error("Lỗi khi tải tin nhắn chat:", error);
                    if (error.code === 'permission-denied') {
                        chatMessagesDiv.innerHTML = '<p class="text-red-500 text-center">Lỗi quyền truy cập: Không thể tải tin nhắn. Vui lòng kiểm tra quy tắc bảo mật Firebase Firestore của bạn.</p>';
                        console.error("Vui lòng kiểm tra quy tắc bảo mật Firebase Firestore của bạn để cho phép đọc/ghi vào collection 'chat_messages' và 'user_profile_data'.");
                    } else {
                        chatMessagesDiv.innerHTML = `<p class="text-red-500 text-center">Không thể tải tin nhắn chat: ${error.message}.</p>`;
                    }
                });

                // Gửi tin nhắn
                if (sendChatButton && chatMessageInput && firestoreAddDoc && firestoreServerTimestamp) {
                    sendChatButton.addEventListener('click', async () => {
                        const messageText = chatMessageInput.value.trim();

                        // Client-side spam checks
                        if (messageText === '') {
                            alert("Tin nhắn không được để trống.");
                            return;
                        }
                        if (messageText.length > MAX_MESSAGE_LENGTH) {
                            alert(`Tin nhắn quá dài. Vui lòng nhập tối đa ${MAX_MESSAGE_LENGTH} ký tự.`);
                            return;
                        }

                        // Cooldown check
                        const currentTime = Date.now();
                        if (currentTime - lastMessageTime < MESSAGE_COOLDOWN) {
                            alert(`Vui lòng chờ ${MESSAGE_COOLDOWN / 1000} giây trước khi gửi tin nhắn tiếp theo.`);
                            return;
                        }

                        // Repetition check (now applies to everyone as there are no moderators)
                        if (isRepeatingMessage(messageText)) {
                             alert("Bạn vừa gửi tin nhắn này rồi. Vui lòng không gửi lại tin nhắn lặp.");
                             return;
                        }
                        
                        // Check if user is banned before allowing to send message
                        if (isBanned) {
                            const banUntilText = banDetails.banUntil === 'permanent' ? 'vĩnh viễn' : `đến ${banDetails.banUntil.toLocaleString('vi-VN')}`;
                            showBanModal(banDetails.reason, banDetails.banUntil === 'permanent' ? 'permanent' : banDetails.banUntil.getTime());
                            alert(`Bạn đang bị cấm gửi tin nhắn. Lý do: ${banDetails.reason}. Cấm đến: ${banUntilText}.`);
                            return;
                        }


                        // Forbidden words check and auto-ban logic
                        if (containsForbiddenWord(messageText)) {
                            currentUserForbiddenWordCount++;
                            const userProfileRef = firestoreDoc(db, 'artifacts', appId, 'users', currentUserId, 'user_profile_data', 'profile_doc');
                            const banDocRef = firestoreDoc(db, 'banned_users', currentUserId);

                            let currentBanLevel = 0;
                            const banSnap = await firestoreGetDoc(banDocRef);
                            if (banSnap.exists()) {
                                currentBanLevel = banSnap.data().banLevel || 0;
                            }

                            if (currentUserForbiddenWordCount >= 2000 && currentBanLevel < 4) {
                                await applyBan(currentUserId, 'permanent', 'Sử dụng từ ngữ không phù hợp (vĩnh viễn)', 4);
                            } else if (currentUserForbiddenWordCount >= 1000 && currentBanLevel < 3) {
                                await applyBan(currentUserId, 30, 'Sử dụng từ ngữ không phù hợp (30 ngày)', 3); // 30 days
                            } else if (currentUserForbiddenWordCount >= 500 && currentBanLevel < 2) {
                                await applyBan(currentUserId, 7, 'Sử dụng từ ngữ không phù hợp (7 ngày)', 2); // 7 days
                            } else if (currentUserForbiddenWordCount >= 100 && currentBanLevel < 1) {
                                await applyBan(currentUserId, 1, 'Sử dụng từ ngữ không phù hợp (1 ngày)', 1); // 1 day
                            }
                            
                            // Update forbidden word count in user profile
                            await firestoreUpdateDoc(userProfileRef, {
                                forbiddenWordCount: currentUserForbiddenWordCount
                            });

                            alert("Tin nhắn chứa từ ngữ không phù hợp. Vui lòng sử dụng ngôn ngữ văn minh.");
                            // Do not send the message if it contains forbidden words
                            return; 
                        }

                        lastMessageTime = currentTime; // Update last send time

                        const user = auth.currentUser;
                        const userId = user ? user.uid : 'anonymous'; 

                        try {
                            await firestoreAddDoc(messagesRef, {
                                text: messageText,
                                userName: currentUserDisplayName, 
                                userId: userId, 
                                timestamp: firestoreServerTimestamp()
                            });
                            chatMessageInput.value = ''; 
                            chatMessageInput.style.height = 'auto'; 

                            // Add sent message to history for repetition check
                            lastSentMessages.push(messageText);
                            if (lastSentMessages.length > LAST_MESSAGES_TO_CHECK) {
                                lastSentMessages.shift(); // Remove the oldest message
                            }

                        } catch (error) {
                            console.error("Lỗi khi gửi tin nhắn:", error);
                            if (error.code === 'permission-denied') {
                                alert("Lỗi quyền truy cập: Bạn không có quyền gửi tin nhắn. Vui lòng kiểm tra quy tắc bảo mật Firebase Firestore của bạn.");
                                console.error("Vui lòng kiểm tra quy tắc bảo mật Firebase Firestore của bạn để cho phép đọc/ghi vào collection 'chat_messages' và 'user_profile_data' và 'banned_users'.");
                            } else {
                                alert("Không thể gửi tin nhắn: " + error.message); 
                            }
                        }
                    });

                    // Tự động điều chỉnh chiều cao textarea khi nhập
                    chatMessageInput.addEventListener('input', () => {
                        chatMessageInput.style.height = 'auto';
                        chatMessageInput.style.height = (chatMessageInput.scrollHeight) + 'px';
                    });

                    // Xử lý sự kiện bàn phím cho chat input: Enter để gửi, Shift+Enter để xuống dòng
                    chatMessageInput.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter' && !event.shiftKey) {
                            event.preventDefault(); 
                            sendChatButton.click(); 
                        }
                        // Nếu là Shift+Enter, không làm gì cả, cho phép xuống dòng mặc định
                    });
                }
            } else {
                console.error("Firebase Firestore hoặc các hàm liên quan chưa được khởi tạo. Đảm bảo bạn đã import đúng.");
                chatMessagesDiv.innerHTML = '<p class="text-red-500 text-center">Chức năng chat không khả dụng do lỗi khởi tạo Firebase.</p>';
            }
            // --- Kết thúc logic cho chức năng chat ---


            // Function to open the modal (for "Server IP" button)
            const openModal = () => {
                if (joinServerModal) {
                    joinServerModal.classList.add('open');
                }
            };

            // Function to close and reset the modal
            const closeAndResetModal = () => {
                if (joinServerModal) {
                    joinServerModal.classList.remove('open');
                }
            };

            // Event listener for the "Server IP" button in the main section
            if (joinServerBtn) {
                joinServerBtn.addEventListener('click', openModal);
            }

            // Event listener for closing the modal via the 'X' button
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeAndResetModal);
            }

            // Event listener for closing the modal by clicking outside its content
            if (joinServerModal) {
                joinServerModal.addEventListener('click', (e) => {
                    if (e.target === joinServerModal) { 
                        closeAndResetModal();
                    }
                });
            }

            // Intersection Observer for scroll-triggered animations (animate elements as they come into view)
            const animateOnScrollElements = document.querySelectorAll('.animated-section'); 

            const observerOptions = {
                root: null, 
                rootMargin: '0px',
                threshold: 0.1 
            };

            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    } 
                });
            }, observerOptions);

            // Observe each element with the 'animated-section' class
            animateOnScrollElements.forEach(element => {
                observer.observe(element);
            });

            // Add Mouse-follow Spotlight and Glow effect to image cards
            // Removed this functionality as per user request to move effects to boxes
            /*
            const spotlightImageCards = document.querySelectorAll('.spotlight-image-card');

            spotlightImageCards.forEach(card => {
                const imageUrl = card.dataset.imageSrc;
                card.style.setProperty('--image-url', `url('${imageUrl}')`); // Set CSS variable for image

                // Create the glow-halo element if it doesn't exist
                let glowHalo = card.querySelector('.glow-halo');
                if (!glowHalo) {
                    glowHalo = document.createElement('div');
                    glowHalo.classList.add('glow-halo');
                    card.appendChild(glowHalo);
                }

                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left; // x position within the element.
                    const y = e.clientY - rect.top;  // y position within the element.

                    // Update CSS variables for the glow halo
                    card.style.setProperty('--mouse-x', `${x}px`);
                    card.style.setProperty('--mouse-y', `${y}px`);
                    card.style.setProperty('--glow-size', '300px'); // Size of the glow
                    card.style.setProperty('--glow-blur', '40px'); // Blur of the glow
                    card.style.setProperty('--glow-opacity', '1'); // Make glow visible
                });

                card.addEventListener('mouseenter', () => {
                    card.style.setProperty('--glow-size', '300px');
                    card.style.setProperty('--glow-blur', '40px');
                    card.style.setProperty('--glow-opacity', '1');
                });

                card.addEventListener('mouseleave', () => {
                    card.style.setProperty('--glow-size', '0px'); // Shrink glow
                    card.style.setProperty('--glow-blur', '0px'); // Reduce blur
                    card.style.setProperty('--glow-opacity', '0'); // Hide glow
                });
            });
            */
        });
    </script>
</body>
</html>
